<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.github.stazxr.zblog.base.mapper.InterfaceMapper">
    <select id="selectInterfaceList" resultType="com.github.stazxr.zblog.base.domain.vo.InterfaceVo">
        SELECT
            tmp.interfaceName, tmp.interfaceCode, tmp.interfaceUri, tmp.interfaceMethod,
            tmp.interfaceLevel, tmp.interfaceStatus,
            tmp.dailyCallCount, tmp.totalCallCount, tmp.totalFailureCount, tmp.callSuccessRate,
            tmp.avgResponseTime, tmp.maxResponseTime, tmp.p95ResponseTime, tmp.p99ResponseTime,
            tmp.maxQps, tmp.avgQps
        FROM (
            SELECT
                r.RESOURCE_NAME AS interfaceName, r.RESOURCE_CODE AS interfaceCode,
                r.RESOURCE_URI AS interfaceUri, r.RESOURCE_METHOD AS interfaceMethod,
                IF(p.PERM_LEVEL IS NULL, r.RESOURCE_LEVEL, p.PERM_LEVEL) AS interfaceLevel,
                IF(p.ENABLED IS NULL, 2, p.ENABLED) AS interfaceStatus,
                -- 当天调用次数
                COUNT(CASE WHEN l.CREATE_DATE = CURRENT_DATE THEN 1 END) AS dailyCallCount,
                -- 累计调用次数
                COUNT(l.ID) AS totalCallCount,
                -- 累计失败次数
                SUM(IF(l.EXEC_RESULT = 0, 1, 0)) AS totalFailureCount,
                -- 成功率
                IF(COUNT(l.ID) = 0, NULL, ROUND(SUM(IF(l.EXEC_RESULT = 1, 1, 0)) / COUNT(l.ID) * 100, 4)) AS callSuccessRate,
                -- 平均响应时间（ms）
                ROUND(AVG(l.COST_TIME), 2) AS avgResponseTime,
                -- 最大响应时间
                MAX(l.COST_TIME) AS maxResponseTime,
                -- P95 响应时间（窗口函数方式）
                (
                    SELECT COST_TIME FROM (
                        SELECT COST_TIME, CUME_DIST() OVER (ORDER BY COST_TIME) AS cum_dist
                        FROM log l2
                        WHERE l2.INTERFACE_CODE = r.RESOURCE_CODE
                        <if test="filterLocalData != null and filterLocalData == true">
                            AND l2.ADDRESS != '局域网'
                        </if>
                    ) t WHERE cum_dist >= 0.95 ORDER BY COST_TIME LIMIT 1
                ) AS p95ResponseTime,
                -- P99 响应时间
                (
                    SELECT COST_TIME FROM (
                        SELECT COST_TIME, CUME_DIST() OVER (ORDER BY COST_TIME) AS cum_dist
                        FROM log l2
                        WHERE l2.INTERFACE_CODE = r.RESOURCE_CODE
                        <if test="filterLocalData != null and filterLocalData == true">
                            AND l2.ADDRESS != '局域网'
                        </if>
                    ) t WHERE cum_dist >= 0.95 ORDER BY COST_TIME LIMIT 1
                ) AS p99ResponseTime,
                -- 峰值 QPS（统计当天每秒请求数的最大值）
                (
                    SELECT MAX(sec_count) FROM (
                        SELECT COUNT(*) AS sec_count FROM log l2
                        WHERE l2.INTERFACE_CODE = r.RESOURCE_CODE AND l2.CREATE_DATE = CURRENT_DATE
                        <if test="filterLocalData != null and filterLocalData == true">
                            AND l2.ADDRESS != '局域网'
                        </if>
                        GROUP BY DATE_FORMAT(l2.EVENT_TIME, '%Y-%m-%d %H:%i:%s')
                    ) qps_sub
                ) AS maxQps,
                -- 平均 QPS（当天总请求数 / 86400秒）
                IF(SUM(IF(l.CREATE_DATE = CURRENT_DATE, 1, 0)) = 0, NULL, ROUND(SUM(IF(l.CREATE_DATE = CURRENT_DATE, 1, 0)) / 86400, 4)) AS avgQps
            FROM resource r
            LEFT JOIN permission p ON p.DELETED = 0 AND p.PERM_CODE = r.RESOURCE_CODE
            LEFT JOIN log l ON l.INTERFACE_CODE = r.RESOURCE_CODE
            <if test="filterLocalData != null and filterLocalData == true">
                AND l.ADDRESS != '局域网'
            </if>
            WHERE r.RESOURCE_CODE IS NOT NULL
            <if test="interfaceName != null and interfaceName != ''">
                <bind name="interfaceNameBind" value="'%' + interfaceName + '%'"/>
                AND r.RESOURCE_NAME LIKE #{interfaceNameBind}
            </if>
            <if test="interfaceCode != null and interfaceCode != ''">
                <bind name="interfaceCodeBind" value="'%' + interfaceCode + '%'"/>
                AND r.RESOURCE_CODE LIKE #{interfaceCodeBind}
            </if>
            <if test="interfaceUri != null and interfaceUri != ''">
                <bind name="interfaceUriBind" value="'%' + interfaceUri + '%'"/>
                AND r.RESOURCE_URI LIKE #{interfaceUriBind}
            </if>
            <if test="interfaceMethod != null and interfaceMethod != ''">
                AND r.RESOURCE_METHOD = #{interfaceMethod}
            </if>
            <if test="interfaceLevel != null">
                AND (IF(p.PERM_LEVEL IS NULL, r.RESOURCE_LEVEL, p.PERM_LEVEL) = #{interfaceLevel})
            </if>
            <if test="interfaceStatus != null">
                AND (IF(p.ENABLED IS NULL, 2, p.ENABLED) = #{interfaceStatus})
            </if>
            GROUP BY r.RESOURCE_CODE, r.RESOURCE_NAME, r.RESOURCE_URI,
            r.RESOURCE_METHOD, r.RESOURCE_LEVEL, p.PERM_LEVEL, p.ENABLED
        ) tmp
        ORDER BY tmp.dailyCallCount DESC, tmp.totalCallCount DESC, tmp.interfaceCode
    </select>
</mapper>
